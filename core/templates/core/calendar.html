{% extends "base.html" %}
{% load static %}

{% block title %}Calendar - NDE IMS{% endblock %}

{% block extra_css %}
<style>
    .calendar-day { min-height: 100px; border: 1px solid #e2e8f0; }
    .calendar-event { font-size: 0.75rem; padding: 2px 4px; margin-bottom: 2px; border-radius: 2px; cursor: pointer; }
    .task-event { background-color: #93C5FD; }
    .project-event { background-color: #6EE7B7; }
    .milestone-event { background-color: #FDE68A; }
</style>
{% endblock %}

{% block content %}
<div x-data="calendar()" x-init="init()" class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="flex justify-between items-center p-4 border-b">
            <h2 class="text-xl font-semibold text-gray-800" x-text="viewTitle"></h2>
            <div class="flex space-x-2">
                <button @click="changeView('month')" :class="{'bg-blue-500 text-white': currentView === 'month'}" class="px-3 py-1 rounded">Month</button>
                <button @click="changeView('week')" :class="{'bg-blue-500 text-white': currentView === 'week'}" class="px-3 py-1 rounded">Week</button>
                <button @click="changeView('day')" :class="{'bg-blue-500 text-white': currentView === 'day'}" class="px-3 py-1 rounded">Day</button>
            </div>
            <div class="flex space-x-2">
                <button @click="previousPeriod" class="text-gray-600 hover:text-gray-800">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <button @click="nextPeriod" class="text-gray-600 hover:text-gray-800">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
        </div>
        
        <!-- Month View -->
        <div x-show="currentView === 'month'">
            <div class="grid grid-cols-7 gap-px border-b border-gray-200 bg-gray-50 text-center text-xs font-semibold leading-6 text-gray-700 uppercase tracking-wider">
                <div class="py-2">Mon</div>
                <div class="py-2">Tue</div>
                <div class="py-2">Wed</div>
                <div class="py-2">Thu</div>
                <div class="py-2">Fri</div>
                <div class="py-2">Sat</div>
                <div class="py-2">Sun</div>
            </div>
            <div class="grid grid-cols-7 gap-px bg-gray-200">
                <template x-for="week in calendarData" :key="week">
                    <template x-for="day in week" :key="day.date">
                        <div class="calendar-day bg-white p-2">
                            <div x-text="day.date" class="font-semibold text-gray-700"></div>
                            <template x-for="event in day.events" :key="event.id">
                                <div :class="{'task-event': event.type === 'task', 'project-event': event.type === 'project', 'milestone-event': event.type === 'milestone'}"
                                     class="calendar-event truncate" x-text="event.title">
                                </div>
                            </template>
                        </div>
                    </template>
                </template>
            </div>
        </div>

        <!-- Week View -->
        <div x-show="currentView === 'week'" class="grid grid-cols-7 gap-px">
            <template x-for="day in weekData" :key="day.date">
                <div class="calendar-day bg-white p-2">
                    <div x-text="formatDate(day.date, 'short')" class="font-semibold text-gray-700"></div>
                    <template x-for="event in day.events" :key="event.id">
                        <div :class="{'task-event': event.type === 'task', 'project-event': event.type === 'project', 'milestone-event': event.type === 'milestone'}"
                             class="calendar-event truncate" x-text="event.title">
                        </div>
                    </template>
                </div>
            </template>
        </div>

        <!-- Day View -->
        <div x-show="currentView === 'day'" class="p-4">
            <div x-text="formatDate(dayData.date, 'full')" class="font-semibold text-gray-700 mb-4"></div>
            <template x-for="event in dayData.events" :key="event.id">
                <div :class="{'task-event': event.type === 'task', 'project-event': event.type === 'project', 'milestone-event': event.type === 'milestone'}"
                     class="calendar-event p-2 mb-2">
                    <div x-text="event.title" class="font-semibold"></div>
                    <div x-text="formatTime(event.start) + ' - ' + formatTime(event.end)" class="text-xs text-gray-600"></div>
                </div>
            </template>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function calendar() {
    return {
        currentView: 'month',
        currentDate: new Date('{{ current_date }}'),
        calendarData: {{ calendar_data|safe }},
        weekData: {{ week_data|safe }},
        dayData: {{ day_data|safe }},
        init() {
            // Any initialization if needed
        },
        changeView(view) {
            this.currentView = view;
        },
        previousPeriod() {
            if (this.currentView === 'month') {
                this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() - 1, 1);
            } else if (this.currentView === 'week') {
                this.currentDate.setDate(this.currentDate.getDate() - 7);
            } else {
                this.currentDate.setDate(this.currentDate.getDate() - 1);
            }
            this.fetchNewData();
        },
        nextPeriod() {
            if (this.currentView === 'month') {
                this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 1);
            } else if (this.currentView === 'week') {
                this.currentDate.setDate(this.currentDate.getDate() + 7);
            } else {
                this.currentDate.setDate(this.currentDate.getDate() + 1);
            }
            this.fetchNewData();
        },
        fetchNewData() {
            // Here you would make an AJAX call to fetch new data based on this.currentDate and this.currentView
            // For now, we'll just log the action
            console.log('Fetching new data for', this.currentView, 'view on', this.currentDate);
        },
        formatDate(dateString, format = 'short') {
            const date = new Date(dateString);
            if (format === 'short') {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            } else {
                return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
        },
        formatTime(dateString) {
            return new Date(dateString).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        },
        get viewTitle() {
            if (this.currentView === 'month') {
                return this.currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            } else if (this.currentView === 'week') {
                const start = new Date(this.currentDate);
                start.setDate(start.getDate() - start.getDay() + 1);
                const end = new Date(start);
                end.setDate(end.getDate() + 6);
                return `${this.formatDate(start)} - ${this.formatDate(end)}`;
            } else {
                return this.formatDate(this.currentDate, 'full');
            }
        }
    };
}
</script>
{% endblock %}