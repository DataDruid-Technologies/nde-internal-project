{% extends 'base_dashboard.html' %}
{% load tailwind_tags %}
{% block dashboard_content %}
<div class="container mx-auto p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white">{{ workflow.name }}</h1>
        <div>
            <a href="{% url 'update_workflow' workflow_id=workflow.id %}" class="bg-primary hover:bg-primary text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out mr-2">
                Edit Workflow
            </a>
            <a href="{% url 'delete_workflow' pk=workflow.id %}" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out">
                Delete Workflow
            </a>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Workflow Details</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-4">{{ workflow.description }}</p>
    </div>

    <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6">
        <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Workflow Steps</h2>
        <div id="workflow-steps" class="relative">
            {% for step in steps %}
                <div id="step-{{ step.id }}" class="workflow-step bg-gray-100 dark:bg-gray-700 p-4 mb-4 rounded-lg">
                    <h3 class="font-semibold text-gray-800 dark:text-white">{{ step.name }}</h3>
                    <p class="text-gray-600 dark:text-gray-400">{{ step.description }}</p>
                    {% if step.required_role %}
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Required Role: {{ step.required_role.name }}</p>
                    {% endif %}
                    {% if step.required_permission %}
                        <p class="text-sm text-gray-500 dark:text-gray-400">Required Permission: {{ step.required_permission.name }}</p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.15.6/js/jsplumb.min.js"></script>
<script>
jsPlumb.ready(function() {
    const instance = jsPlumb.getInstance({
        Connector: ["Bezier", { curviness: 50 }],
        PaintStyle: { stroke: "#456" },
        EndpointStyle: { fill: "#456" },
        Container: "workflow-steps"
    });

    {% for step in steps %}
        instance.addEndpoint("step-{{ step.id }}", {
            anchor: "Right",
            isSource: true,
            isTarget: false,
            maxConnections: -1
        });
        instance.addEndpoint("step-{{ step.id }}", {
            anchor: "Left",
            isSource: false,
            isTarget: true,
            maxConnections: -1
        });
    {% endfor %}

    {% for connection in connections %}
        instance.connect({
            source: "step-{{ connection.source_step.id }}",
            target: "step-{{ connection.target_step.id }}"
        });
    {% endfor %}
});
</script>
{% endblock %}